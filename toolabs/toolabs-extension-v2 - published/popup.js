document.addEventListener("DOMContentLoaded",(function(){console.log("Script loaded");const e=chrome.runtime.getManifest().homepage_url,t=e+"/dashboard";document.getElementById("dashboard-url").href=e+"/dashboard/app";let o,n;document.getElementById("profile-url").href=e+"/dashboard/profile";const s=new Headers;s.append("Authorization",`Bearer ${o}`);let r="";const a=(e,t)=>({method:e,headers:s,..."GET"!==e&&{body:t},redirect:"follow"}),c=document.getElementById("searchbar-input"),i=document.querySelector(".swiper-wrapper");function l(){chrome.tabs.create({url:e,active:!1},(e=>{chrome.tabs.onUpdated.addListener((function s(r,a){r===e.id&&"complete"===a.status&&chrome.scripting.executeScript({target:{tabId:e.id},func:()=>({accessToken:localStorage.getItem("accessToken"),refreshToken:localStorage.getItem("refreshToken")})},(r=>{const a=r[0]?.result,c=a?.accessToken,i=a?.refreshToken;c&&i?(console.log("Token ditemukan:",c),d(c),o=c,n=i):(chrome.tabs.update(e.id,{url:t}),chrome.tabs.create({url:t}),window.close()),chrome.tabs.remove(e.id),chrome.tabs.onUpdated.removeListener(s)}))}))}))}function d(o){console.log("Validating token..."),r=JSON.stringify({token:o}),fetch(`${e}/api/member/auth/validate`,a("POST",r)).then((e=>(e.ok||(u(),chrome.tabs.create({url:t}),window.close()),e.json()))).then((l=>{console.log("Token validate:",o),s.set("Authorization",`Bearer ${o}`),document.getElementById("loading").classList.add("hidden"),document.getElementById("primaryNav").classList.remove("hidden"),document.getElementById("mainContent").classList.remove("hidden"),function(){fetch(`${e}/api/public/extension-banner`).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{!function(e){i.innerHTML="",e.forEach((e=>{const t=document.createElement("div");t.className="swiper-slide rounded-2xl lg:rounded-3xl p-10 lg:p-16",t.innerHTML=`\n                <img src="${e.background}" alt="${e.background}" />\n                <h1 class="text-white text-2xl lg:text-4xl font-bold">${e.text}</h1>\n            `,i.appendChild(t)}))}(e),function(){new Swiper(".swiper-container",{slidesPerView:1,spaceBetween:30,loop:!1,pagination:{el:".swiper-pagination",type:"custom",renderCustom:function(e,t,o){for(var n="",s=0;s<o;s++)n+=`<span class="swiper-pagination-bullet ${s===e.realIndex?"bg-secondary":"bg-gray-400"} w-10 h-1 rounded-2xl mx-1 cursor-pointer"></span>`;return n}},autoplay:{delay:5e3,disableOnInteraction:!1}});const e=document.getElementById("banner");e&&e.classList.remove("hidden")}()})).catch((e=>{console.error("Error fetching banner data:",e)}));const t=document.getElementById("user-menu-button"),o=document.getElementById("user-menu");t.addEventListener("click",(function(){o.classList.toggle("hidden")})),document.addEventListener("click",(function(e){o.contains(e.target)||t.contains(e.target)||o.classList.add("hidden")})),document.getElementById("searchbar-button").addEventListener("click",(function(e){const t=document.getElementsByClassName("block-logo")[0];t.style.maxWidth="32px",t.style.transition="0s",c.style.visibility="visible",c.style.opacity="1",setTimeout((()=>{c.focus()}),200),e.stopPropagation()})),document.addEventListener("click",(function(e){const t=document.getElementsByClassName("block-logo")[0];document.querySelector(".searchbar").contains(e.target)||(c.value="",t.style.maxWidth="100%",t.style.transition=".1s",c.style.visibility="collapse",c.style.opacity="0",c.style.transition="0s")}));const n=document.getElementById("categories"),s=document.getElementById("primaryNav"),r=document.getElementById("banner"),a=r.offsetHeight,l=document.getElementById("mainContent"),d=l.offsetTop,u=l.offsetHeight;window.addEventListener("scroll",(function(){const e=r.offsetTop+a,t=d+u;window.scrollY>d&&window.scrollY<t?s.classList.remove("shadow-nav","nav-transition"):s.classList.add("shadow-nav","nav-transition"),window.scrollY>e?n.classList.add("z-40","shadow-nav","nav-transition"):n.classList.remove("z-40","shadow-nav","nav-transition")}));const m=document.querySelector(".categories"),h=document.querySelector(".prev"),p=document.querySelector(".next");let g,f,E=!1;function v(){const e=m.scrollWidth-m.clientWidth;h.classList.toggle("hidden",m.scrollLeft<=0),p.classList.toggle("hidden",m.scrollLeft>=e),m.classList.add("scrolling")}function b(e){const t=m.clientWidth;m.scrollBy({left:e*t,behavior:"smooth"}),m.classList.add("scrolling"),setTimeout((()=>{m.classList.remove("scrolling")}),500)}document.getElementById("navSlideLeft").addEventListener("click",(function(){console.log("navSlideLeft click"),b(-1)})),document.getElementById("navSlideRight").addEventListener("click",(function(){console.log("navSlideRight click"),b(1)})),m.addEventListener("scroll",v),window.addEventListener("resize",v),m.addEventListener("mousedown",(e=>{E=!0,m.classList.add("dragging"),g=e.pageX-m.offsetLeft,f=m.scrollLeft})),m.addEventListener("mouseleave",(()=>{E=!1,m.classList.remove("dragging"),m.classList.remove("scrolling")})),m.addEventListener("mouseup",(()=>{E=!1,m.classList.remove("dragging"),m.classList.remove("scrolling")})),m.addEventListener("mousemove",(e=>{if(!E)return;e.preventDefault();const t=3*(e.pageX-m.offsetLeft-g);m.scrollLeft=f-t})),v()}(),function(){g(),d();function o(){console.log("Refreshing token..."),fetch(`${e}/api/member/auth/refresh-token`,{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({refreshToken:n})}).then((e=>{if(!e.ok)throw new Error(`Refresh token failed with status ${e.status}`);return e.json()})).then((e=>{console.log("Token refreshed:",e.accessToken),s.set("Authorization",`Bearer ${e.accessToken}`),i()})).catch((e=>{console.error("Error refreshing token:",e)}))}function i(){console.log("Attempting logout..."),fetch(`${e}/api/member/auth/logout`,a("POST",r)).then((e=>{if(200===e.status)return console.log("Logout berhasil:",e),u(),e.text();throw o(),new Error(`Logout failed with status ${e.status}`)})).then((e=>{console.log("Logout berhasil:",e),chrome.tabs.create({url:t}),window.close()})).catch((e=>{}))}function l(){console.log("Refreshing token..."),fetch(`${e}/api/member/auth/refresh-token`,{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({refreshToken:n})}).then((e=>{if(!e.ok)throw new Error(`Refresh token failed with status ${e.status}`);return e.json()})).then((e=>{console.log("Token refreshed:",e.accessToken),s.set("Authorization",`Bearer ${e.accessToken}`),d()})).catch((e=>{console.error("Error refreshing token:",e)}))}function d(t=null){console.log("Get tools...");fetch(`${e}${t?`/api/member/tools/categories?id=${t}`:"/api/member/tools"}`,a("GET","")).then((e=>{if(200===e.status)return console.log("Get tools berhasil:",e),e.json();throw l(),new Error(`Get tools failed with status ${e.status}`)})).then((e=>{const t=document.getElementById("tools-container");t.innerHTML="";(Array.isArray(e)?e:[e]).forEach((e=>{const o=document.createElement("div");o.classList.add("toolsGroup","py-2");const n=document.createElement("h1");n.classList.add("text-2xl","font-semibold","text-white"),n.textContent=e.category,o.appendChild(n);const s=document.createElement("div");s.classList.add("mt-4","space-y-4"),e.logos.forEach((e=>{const t=document.createElement("div");t.classList.add("group","flex","flex-col","rounded-2xl","bg-accordion","p-5","text-white"),t.setAttribute("tabindex","1");const o=document.createElement("div");o.classList.add("flex","cursor-pointer","py-1","items-center","justify-between");const n=document.createElement("div");n.classList.add("flex","gap-5","items-center");const r=document.createElement("img");r.src=e.logo,r.alt=`${e.groupName} logo`,r.classList.add("w-11","h-auto","rounded-2xl");const a=document.createElement("span");a.classList.add("text-lg"),a.textContent=e.groupName,n.appendChild(r),n.appendChild(a);const c=document.createElement("img");c.src="https://upload.wikimedia.org/wikipedia/commons/9/96/Chevron-icon-drop-down-menu-WHITE.png",c.classList.add("h-auto","w-4","transition-all","duration-500","group-focus:-rotate-180"),o.appendChild(n),o.appendChild(c);const i=document.createElement("div");i.classList.add("invisible","h-auto","max-h-0","items-center","opacity-0","transition-all","group-focus:visible","group-focus:max-h-screen","group-focus:opacity-100","group-focus:duration-1000");const l=document.createElement("p");l.classList.add("mt-2","text-justify"),l.innerHTML=e.description;const d=document.createElement("div");d.classList.add("server-wrapper","flex","flex-wrap","gap-4","mt-6","text-sm"),e.tools.forEach(((e,t)=>{const o=document.createElement("button");if(o.classList.add("serverItem","px-3","py-2"),o.textContent=`Server ${t+1}`,e.isMaintenance){o.classList.add("server-disable");const e=document.createElement("span");e.classList.add("serverTooltip"),e.textContent="Under Maintenance";const t=document.createElement("img");t.src="https://cdn.toolabs.live/img/extension/disable-icon.png",t.alt="Maintenance Icon",o.appendChild(e),o.appendChild(t)}o.addEventListener("click",(()=>E(e.id))),d.appendChild(o)})),i.appendChild(l),i.appendChild(d),t.appendChild(o),t.appendChild(i),s.appendChild(t)})),o.appendChild(s),t.appendChild(o)})),console.log("Get tools berhasil:",e)})).catch((e=>{console.error("Error Get tools:",e.message)}))}function m(t){fetch(`${e}/api/member/tools?name=${encodeURIComponent(t)}`,a("GET","")).then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{console.log("Hasil pencarian:",e);const t=document.getElementById("tools-container");t.innerHTML="";(Array.isArray(e)?e:[e]).forEach((e=>{const o=document.createElement("div");o.classList.add("toolsGroup","py-2");const n=document.createElement("h1");n.classList.add("text-2xl","font-semibold","text-white"),n.textContent=e.category,o.appendChild(n);const s=document.createElement("div");s.classList.add("mt-4","space-y-4"),e.logos.forEach((e=>{const t=document.createElement("div");t.classList.add("group","flex","flex-col","rounded-2xl","bg-accordion","p-5","text-white"),t.setAttribute("tabindex","1");const o=document.createElement("div");o.classList.add("flex","cursor-pointer","py-1","items-center","justify-between");const n=document.createElement("div");n.classList.add("flex","gap-5","items-center");const r=document.createElement("img");r.src=e.logo,r.alt=`${e.groupName} logo`,r.classList.add("w-11","h-auto","rounded-2xl");const a=document.createElement("span");a.classList.add("text-lg"),a.textContent=e.groupName,n.appendChild(r),n.appendChild(a);const c=document.createElement("img");c.src="https://upload.wikimedia.org/wikipedia/commons/9/96/Chevron-icon-drop-down-menu-WHITE.png",c.classList.add("h-auto","w-4","transition-all","duration-500","group-focus:-rotate-180"),o.appendChild(n),o.appendChild(c);const i=document.createElement("div");i.classList.add("invisible","h-auto","max-h-0","items-center","opacity-0","transition-all","group-focus:visible","group-focus:max-h-screen","group-focus:opacity-100","group-focus:duration-1000");const l=document.createElement("p");l.classList.add("mt-2","text-justify"),l.innerHTML=e.description;const d=document.createElement("div");d.classList.add("server-wrapper","flex","flex-wrap","gap-4","mt-6","text-sm"),e.tools.forEach(((e,t)=>{const o=document.createElement("button");if(o.classList.add("serverItem","px-3","py-2"),o.textContent=`Server ${t+1}`,e.isMaintenance){o.classList.add("server-disable");const e=document.createElement("span");e.classList.add("serverTooltip"),e.textContent="Under Maintenance";const t=document.createElement("img");t.src="https://cdn.toolabs.live/img/extension/disable-icon.png",t.alt="Maintenance Icon",o.appendChild(e),o.appendChild(t)}o.addEventListener("click",(()=>E(e.id))),d.appendChild(o)})),i.appendChild(l),i.appendChild(d),t.appendChild(o),t.appendChild(i),s.appendChild(t)})),o.appendChild(s),t.appendChild(o)})),console.log("Get tools berhasil:",e)})).catch((e=>{console.error("Error saat pencarian:",e)}))}let h;function p(){console.log("Refreshing token..."),fetch(`${e}/api/member/auth/refresh-token`,{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({refreshToken:n})}).then((e=>{if(!e.ok)throw new Error(`Refresh token failed with status ${e.status}`);return e.json()})).then((e=>{console.log("Token refreshed:",e.accessToken),s.set("Authorization",`Bearer ${e.accessToken}`),g()})).catch((e=>{console.error("Error refreshing token:",e)}))}function g(){console.log("Get categories..."),fetch(`${e}/api/member/tools/categories`,a("GET","")).then((e=>{if(200===e.status)return console.log("Get categories berhasil:",e),e.json();throw p(),new Error(`Get categories failed with status ${e.status}`)})).then((e=>{const t=document.getElementById("categories-container"),o=document.createElement("button");o.classList.add("category","flex-none","px-4","py-2","categoryItem","category-active"),o.textContent="All Tools",o.addEventListener("click",(()=>{b(o),d()})),t.appendChild(o),e.forEach((e=>{const o=document.createElement("button");o.classList.add("category","flex-none","px-4","py-2","categoryItem"),o.textContent=e.name,o.addEventListener("click",(()=>{b(o),d(e.id)})),t.appendChild(o)})),console.log("Get categories berhasil:",e)})).catch((e=>{console.error("Error Get categories:",e.message)}))}function f(t){console.log("Refreshing token..."),fetch(`${e}/api/member/auth/refresh-token`,{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({refreshToken:n})}).then((e=>{if(!e.ok)throw new Error(`Refresh token failed with status ${e.status}`);return e.json()})).then((e=>{console.log("Token refreshed:",e.accessToken),s.set("Authorization",`Bearer ${e.accessToken}`),E(t)})).catch((e=>{console.error("Error refreshing token:",e)}))}function E(t){fetch(`${e}/api/member/tools/${t}`,a("GET","")).then((e=>{if(200===e.status)return console.log("Get tools by id berhasil:",e),e.json();throw f(t),new Error(`Get tools by id failed with status ${e.status}`)})).then((e=>{e.url.includes("docs.google.com")||e.url.includes("toolabs.live")?chrome.tabs.create({url:e.url,active:!0},(t=>{console.log(`Redirect langsung ke: ${e.url} dengan ID tab: ${t.id}`)})):v(e.url,e.key,(()=>{chrome.tabs.create({url:e.url,active:!0},(e=>{console.log(`Tab baru dibuka dengan ID: ${e.id}`)}))})),console.log("Get tools by id berhasil:",e)})).catch((e=>{console.error("Error tools by id:",e.message)}))}function v(e,t,o){let n=0;t.forEach((s=>{chrome.cookies.set({url:e,name:s.name,value:s.value,domain:s.domain,path:"/",...s.name.startsWith("__Secure-")&&{secure:!0},...s.name.startsWith("__Host-")&&{secure:!0,domain:void 0}},(()=>{n++,n===t.length&&o()}))}))}document.getElementById("signout").addEventListener("click",i),c.addEventListener("input",(e=>{const t=e.target.value.trim();t.length>0?(clearTimeout(h),h=setTimeout((()=>m(t)),300)):d()}));const b=e=>{document.querySelectorAll(".categoryItem").forEach((e=>e.classList.remove("category-active"))),e.classList.add("category-active")}}()})).catch((e=>{u(),chrome.tabs.create({url:t}),window.close()}))}function u(){console.log("Menghapus localStorage..."),localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}chrome.tabs.query({active:!0,currentWindow:!0},(s=>{0===s.length&&l();const r=s[0].url;console.log("URL tab aktif:",r),new URL(r).hostname===new URL(e).hostname?chrome.tabs.query({active:!0,currentWindow:!0},(e=>{0===e.length&&l(),chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>({accessToken:localStorage.getItem("accessToken"),refreshToken:localStorage.getItem("refreshToken")})},(e=>{if(chrome.runtime.lastError)return void console.error("Error saat membaca localStorage:",chrome.runtime.lastError.message);const s=e[0]?.result;s.accessToken&&s.refreshToken?(console.log("Token ditemukan:",s.accessToken),d(s.accessToken),o=s.accessToken,n=s.refreshToken):(window.open(t,"_blank"),window.close())}))})):l()}))}));